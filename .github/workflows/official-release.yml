name: Official Release Build

on:
  push:
    tags:
      - '[0-9]*'
  workflow_dispatch:
jobs:
  build-and-release:
    name: Build All Formats and Release
    runs-on: windows-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'liberica'

      - name: Install WiX Toolset
        run: choco install wixtoolset

      - name: Install Enigma Virtual Box
        shell: pwsh
        run: |
          curl -L -o evb_setup.exe https://enigmaprotector.com/assets/files/enigmavb.exe
        
          Write-Host "Starting installation..." -ForegroundColor Cyan
          $process = Start-Process -FilePath .\evb_setup.exe -ArgumentList '/VERYSILENT', '/SUPPRESSMSGBOXES', '/NORESTART', '/SP-' -PassThru
          
          $process | Wait-Process -Timeout 180 -ErrorAction SilentlyContinue
          
          Stop-Process -Name "evb_setup" -ErrorAction SilentlyContinue
          
          $EVB_CONSOLE = "C:\Program Files (x86)\Enigma Virtual Box\enigmavbconsole.exe"
          if (Test-Path $EVB_CONSOLE) {
            Write-Host "SUCCESS: EVB is physically located at $EVB_CONSOLE" -ForegroundColor Green
          } else {
            Write-Host "CRITICAL ERROR: EVB files were not written to disk!" -ForegroundColor Red
            exit 1
          }
      - name: Build Source Code
        shell: pwsh
        run: |
          $props = Get-Content ".build/properties.json" | ConvertFrom-Json
          $BaseName    = $props.name
          New-Item -ItemType Directory -Path "out/production/${BaseName}" -Force
          New-Item -ItemType Directory -Path "out/artifacts/${BaseName}_jar" -Force

          $CLASSPATH = ".;lib/*" 
          Write-Host "Compiling Java source files..." -ForegroundColor Cyan
          $javaFiles = Get-ChildItem -Recurse src/*.java | Select-Object -ExpandProperty FullName
          javac -encoding UTF-8 -d out/production/${BaseName} $javaFiles

          Write-Host "Packaging into JAR..." -ForegroundColor Cyan
          jar --create --file out/artifacts/${BaseName}_jar/${BaseName}.jar --main-class io.github.samera2022.chinese_chess.ChineseChess .
          
          if (Test-Path "out/artifacts/${BaseName}_jar/${BaseName}.jar") {
             Write-Host "Successfully built JAR!" -ForegroundColor Green
          } else {
             Write-Host "Failed to build JAR." -ForegroundColor Red
             exit 1
          }

      - name: Execute All Packaging Scripts
        shell: pwsh
        env:
          MSI_WIN_UPGRADE_UUID: ${{ secrets.WIX_UPGRADE_UUID }}
          MSIX_WIN_PY_PACKAGE_NAME: ${{ secrets.MSIX_PACKAGE_NAME }}
          MSIX_WIN_PY_PUBLISHER_NAME: ${{ secrets.MSIX_PUBLISHER_ID }}
          MSIX_WIN_PY_PUBLISHER_DISPLAY_NAME: ${{ secrets.MSIX_PUBLISHER_DISPLAY_NAME }}
        run: |
          Write-Host "Starting Multi-format Packaging..." -ForegroundColor Magenta
          
          ./.build/jpackage_build.ps1 -Type jar
          ./.build/jpackage_build.ps1 -Type zip
          ./.build/jpackage_build.ps1 -Type exe
          
          Write-Host "All packaging steps completed." -ForegroundColor Green
      - name: Generate Changelog from JSON
        id: changelog_gen
        shell: pwsh
        run: |
            $targetVersion = "${{ github.ref_name }}"
            $jsonPath = "resources/updates.json"
            if (-not (Test-Path $jsonPath)) {
                "Release for $targetVersion" | Out-File -FilePath release_body.txt
                exit 0
            }
            $updates = Get-Content $jsonPath -Raw | ConvertFrom-Json
            $entry = $updates."$targetVersion"
            
            if ($null -eq $entry) {
                Write-Host "Warning: Version $targetVersion not found in updates.json" -ForegroundColor Yellow
                $finalLog = "Release for version $targetVersion"
            } else {
                $date = $entry.releaseDate
                $desc = $entry.description
                $finalLog = "[$date] $targetVersion`n`n$desc"
            }
            $Utf8NoBomEncoding = New-Object System.Text.UTF8Encoding $False
            [System.IO.File]::WriteAllLines("$(Get-Location)/release_body.txt", $finalLog, $Utf8NoBomEncoding)
      - name: Publish to GitHub Releases
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ github.ref_name }}
          body_path: release_body.txt
          draft: false
          prerelease: false
          files: |
            output/*.jar
            output/*.zip
            output/*.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}